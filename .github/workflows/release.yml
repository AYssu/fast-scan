name: Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0, v2.1.0

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–æ‰€æœ‰åŽ†å²è®°å½•å’Œæ ‡ç­¾
      
      - name: Get tag name
        id: tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Create source archive
        run: |
          # åˆ›å»ºæºç åŽ‹ç¼©åŒ…ï¼ˆåŒ…å«æ‰€æœ‰æ–‡ä»¶ï¼‰
          zip -r fast-scan-${{ steps.tag.outputs.TAG_NAME }}-source.zip . \
            -x "*.git*" \
            -x "*node_modules*" \
            -x "*.github*"
          
          # åˆ›å»ºæ–‡æ¡£å’Œè„šæœ¬åŒ…
          mkdir -p release-files
          
          # å¤åˆ¶ä¸»è¦æ–‡æ¡£å’Œè„šæœ¬
          cp README.md release-files/ 2>/dev/null || true
          cp ä½¿ç”¨æ•™ç¨‹.txt release-files/ 2>/dev/null || true
          
          # å¤åˆ¶åŠ¨æ€åŸºå€æ¨¡æ¿
          if [ -d "åŠ¨æ€åŸºå€æ¨¡æ¿" ]; then
            cp -r "åŠ¨æ€åŸºå€æ¨¡æ¿" release-files/
          fi
          
          # å¤åˆ¶æ‰«æè½¯ä»¶
          if [ -d "æ‰«æè½¯ä»¶" ]; then
            cp -r "æ‰«æè½¯ä»¶" release-files/
          fi
          
          # å¤åˆ¶luaé›†æˆCæ‰«
          if [ -d "luaé›†æˆCæ‰«" ]; then
            cp -r "luaé›†æˆCæ‰«" release-files/
          fi
          
          # æ‰“åŒ…æ–‡æ¡£å’Œå·¥å…·
          cd release-files
          zip -r ../fast-scan-${{ steps.tag.outputs.TAG_NAME }}-tools.zip .
          cd ..
      
      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## FastScan ${{ steps.tag.outputs.TAG_NAME }}
          
          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          
          - **fast-scan-${{ steps.tag.outputs.TAG_NAME }}-source.zip**: å®Œæ•´æºç åŒ…
          - **fast-scan-${{ steps.tag.outputs.TAG_NAME }}-tools.zip**: å·¥å…·å’Œæ–‡æ¡£åŒ…ï¼ˆåŒ…å«æ‰«æè½¯ä»¶ã€åŠ¨æ€åŸºå€æ¨¡æ¿ç­‰ï¼‰
          
          ### ðŸš€ å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½å¯¹åº”çš„åŽ‹ç¼©åŒ…
          2. è§£åŽ‹åˆ°ç›®æ ‡ç›®å½•
          3. å‚è€ƒ README.md æˆ– ä½¿ç”¨æ•™ç¨‹.txt å¼€å§‹ä½¿ç”¨
          
          ### âš ï¸ ä½¿ç”¨é¡»çŸ¥
          
          - éœ€è¦ Root æƒé™è¿è¡Œ
          - æ”¯æŒçœŸæœº64ä½ã€è™šæ‹Ÿæœº64ä½ã€æ¨¡æ‹Ÿå™¨64ä½
          - è¯¦ç»†ä½¿ç”¨è¯´æ˜Žè¯·æŸ¥çœ‹æ–‡æ¡£
          
          ### ðŸ“ æ›´æ–°å†…å®¹
          
          è¯·æŸ¥çœ‹æäº¤è®°å½•äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          EOF
          
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.TAG_NAME }}
          name: FastScan ${{ steps.tag.outputs.TAG_NAME }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            fast-scan-${{ steps.tag.outputs.TAG_NAME }}-source.zip
            fast-scan-${{ steps.tag.outputs.TAG_NAME }}-tools.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Cleanup
        if: always()
        run: |
          rm -rf release-files
          rm -f release_notes.md

